import { slugifyWithCounter } from '@sindresorhus/slugify';
import { visit } from 'unist-util-visit';
import { createMdxJsxAttribute, getUnicodeId } from '../../lib/remark-utils.js';
import { getTOCTitle } from '../../lib/remark-utils.js';
export const remarkHeadingIds = () => (tree) => {
    const slugify = slugifyWithCounter();
    visit(tree, 'heading', (node) => {
        if ([1, 2, 3, 4].includes(node.depth)) {
            const title = getTOCTitle(node);
            const encodedTitle = getUnicodeId(title);
            let slug;
            // if encoded title is already percent-encoded, return it as is
            // slugify doesn't support percent-encoded characters, like Chinese, Korean, etc.
            if (/%[0-9A-F]{2}/.test(encodedTitle)) {
                slug = slugify(encodedTitle, {
                    decamelize: false,
                    preserveCharacters: ['%'],
                    lowercase: false,
                });
            }
            else {
                slug = slugify(encodedTitle, { decamelize: false });
            }
            const mdxJsxAttributes = [
                createMdxJsxAttribute('level', node.depth),
                createMdxJsxAttribute('id', slug),
            ];
            // eslint-disable-next-line @typescript-eslint/no-explicit-any
            node.attributes = mdxJsxAttributes;
            // eslint-disable-next-line @typescript-eslint/no-explicit-any
            node.type = 'mdxJsxFlowElement';
            // eslint-disable-next-line @typescript-eslint/no-explicit-any
            node.name = 'Heading';
        }
    });
};
